#!/usr/bin/env bash
set -euo pipefail

# Load shared functions
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BLOG_ROOT="$(dirname "$SCRIPT_DIR")"

# shellcheck source=script/lib/config-loader.sh
source "$SCRIPT_DIR/lib/config-loader.sh"

# Load configuration (optional for new-post)
CONFIG_FILE="$BLOG_ROOT/.blog-config.yml"
load_blog_config "$CONFIG_FILE" false

# Prompt for post details
echo "Create a new blog post"
echo ""
read -rp "Title: " title

if [[ -z "$title" ]]; then
  echo "Error: Title cannot be empty" >&2
  exit 1
fi

read -rp "Slug (press Enter to auto-generate): " slug

# Auto-generate slug if not provided
if [[ -z "$slug" ]]; then
  slug=$(echo "$title" | tr '[:upper:]' '[:lower:]' | \
    sed 's/[^a-z0-9 -]//g' | \
    sed 's/ \+/-/g' | \
    sed 's/-\+/-/g' | \
    sed 's/^-\|-$//g')

  # Validate slug is not empty
  if [[ -z "$slug" ]]; then
    echo "Error: Could not generate a valid slug from title" >&2
    echo "Title contains only special characters. Please provide a slug manually." >&2
    read -rp "Enter slug: " slug

    if [[ -z "$slug" ]]; then
      echo "Error: Slug cannot be empty" >&2
      exit 1
    fi
  fi
fi

# Generate date and filename
date_str=$(date +%Y-%m-%d)
year=$(date +%Y)
filename="${date_str}-${slug}.md"

# Create paths
posts_dir="$BLOG_ROOT/_posts/$year"
post_path="$posts_dir/$filename"
draft_images_dir="$BLOG_ROOT/.draft-images/${date_str}-${slug}"

# Check if post already exists
if [[ -f "$post_path" ]]; then
  echo "Error: Post already exists at $post_path" >&2
  exit 1
fi

# Create directories
mkdir -p "$posts_dir"
mkdir -p "$draft_images_dir"

# Create post with front matter
cat > "$post_path" <<EOF
---
title: "$title"
description: ""
tags: []
excerpt_image: ""
---

Write your post here…

<!-- Use placeholders like [image1: Description of image] for images -->
EOF

echo ""
echo "✓ Created post: $post_path"
echo "✓ Created draft images directory: $draft_images_dir"
echo ""
echo "Next steps:"
echo "  1. Edit your post and add image placeholders: [image1: description]"
echo "  2. Add any existing images to: .draft-images/${date_str}-${slug}/"
echo "  3. Run: ./script/generate-images _posts/$year/$filename"

# Open in editor if configured
if [[ -n "${EDITOR:-}" ]]; then
  if validate_editor "$EDITOR"; then
    exec "$EDITOR" "$post_path"
  fi
fi
